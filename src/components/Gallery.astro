---
import GalleryReact from './GalleryReact';
import Modal from './Modal.astro';
import Drawer from './Drawer.astro';
import "../styles/global.css";
import { processImages } from "../utils/imageProcessing";

// Initial fetch with pagination
const response = await fetch("http://127.0.0.1:8000/images?page=1&page_size=20");
const jsonBody = await response.json();
const imagesData = jsonBody["images"];
const initialTotalPages = jsonBody["total_pages"] || 1;

// Process images into rows
const rows = processImages(imagesData);
---

<div class="container mx-auto px-1 space-y-2">
  <GalleryReact client:load initialImages={imagesData} initialTotalPages={initialTotalPages} />
</div>

<Modal />

<Drawer title="Gallery Settings" isOpen={false}>
  <div class="space-y-4">
    <div>
      <h3 class="text-lg font-medium text-gray-900">Display Settings</h3>
      <p class="text-sm text-gray-500">Customize how your gallery is displayed.</p>
    </div>
    <div class="space-y-2">
      <label class="flex items-center">
        <input type="checkbox" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        <span class="ml-2 text-sm text-gray-600">Show image details</span>
      </label>
      <label class="flex items-center">
        <input type="checkbox" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        <span class="ml-2 text-sm text-gray-600">Enable hover effects</span>
      </label>
    </div>
  </div>
</Drawer>

<script>
  // Add click handlers to all image containers
  document.addEventListener('DOMContentLoaded', () => {
    const imageContainers = document.querySelectorAll('[data-image-url]');
    imageContainers.forEach(container => {
      container.addEventListener('click', () => {
        const imageUrl = container.getAttribute('data-image-url');
        const filename = container.getAttribute('data-filename');
        const size = container.getAttribute('data-size');
        const created = container.getAttribute('data-created');
        
        if (imageUrl && filename && size && created) {
          // Use the Modal's openModal function which handles keyboard navigation
          const modal = document.getElementById('modal');
          if (modal) {
            const modalScript = modal.querySelector('script');
            if (modalScript) {
              const openModalFunction = (window as any).openModal;
              if (openModalFunction) {
                openModalFunction(imageUrl, filename, size, created);
              }
            }
          }
        }
      });
    });
  });
</script>
